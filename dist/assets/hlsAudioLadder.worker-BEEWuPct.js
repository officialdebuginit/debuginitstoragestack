var Y=Object.defineProperty;var W=t=>{throw TypeError(t)};var q=(t,e,s)=>e in t?Y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var c=(t,e,s)=>q(t,typeof e!="symbol"?e+"":e,s),k=(t,e,s)=>e.has(t)||W("Cannot "+s);var i=(t,e,s)=>(k(t,e,"read from private field"),s?s.call(t):e.get(t)),g=(t,e,s)=>e.has(t)?W("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),w=(t,e,s,n)=>(k(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s);var r;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(r||(r={}));const J=(()=>{let t=0;return()=>t++})(),V=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),Q=new Error("called FFmpeg.terminate()");var E,D,m,O,L,b,l;class Z{constructor(){g(this,E,null);g(this,D,{});g(this,m,{});g(this,O,[]);g(this,L,[]);c(this,"loaded",!1);g(this,b,()=>{i(this,E)&&(i(this,E).onmessage=({data:{id:e,type:s,data:n}})=>{switch(s){case r.LOAD:this.loaded=!0,i(this,D)[e](n);break;case r.MOUNT:case r.UNMOUNT:case r.EXEC:case r.FFPROBE:case r.WRITE_FILE:case r.READ_FILE:case r.DELETE_FILE:case r.RENAME:case r.CREATE_DIR:case r.LIST_DIR:case r.DELETE_DIR:i(this,D)[e](n);break;case r.LOG:i(this,O).forEach(a=>a(n));break;case r.PROGRESS:i(this,L).forEach(a=>a(n));break;case r.ERROR:i(this,m)[e](n);break}delete i(this,D)[e],delete i(this,m)[e]})});g(this,l,({type:e,data:s},n=[],a)=>i(this,E)?new Promise((o,_)=>{const R=J();i(this,E)&&i(this,E).postMessage({id:R,type:e,data:s},n),i(this,D)[R]=o,i(this,m)[R]=_,a==null||a.addEventListener("abort",()=>{_(new DOMException(`Message # ${R} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(V));c(this,"load",({classWorkerURL:e,...s}={},{signal:n}={})=>(i(this,E)||(w(this,E,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),i(this,b).call(this)),i(this,l).call(this,{type:r.LOAD,data:s},void 0,n)));c(this,"exec",(e,s=-1,{signal:n}={})=>i(this,l).call(this,{type:r.EXEC,data:{args:e,timeout:s}},void 0,n));c(this,"ffprobe",(e,s=-1,{signal:n}={})=>i(this,l).call(this,{type:r.FFPROBE,data:{args:e,timeout:s}},void 0,n));c(this,"terminate",()=>{const e=Object.keys(i(this,m));for(const s of e)i(this,m)[s](Q),delete i(this,m)[s],delete i(this,D)[s];i(this,E)&&(i(this,E).terminate(),w(this,E,null),this.loaded=!1)});c(this,"writeFile",(e,s,{signal:n}={})=>{const a=[];return s instanceof Uint8Array&&a.push(s.buffer),i(this,l).call(this,{type:r.WRITE_FILE,data:{path:e,data:s}},a,n)});c(this,"mount",(e,s,n)=>{const a=[];return i(this,l).call(this,{type:r.MOUNT,data:{fsType:e,options:s,mountPoint:n}},a)});c(this,"unmount",e=>{const s=[];return i(this,l).call(this,{type:r.UNMOUNT,data:{mountPoint:e}},s)});c(this,"readFile",(e,s="binary",{signal:n}={})=>i(this,l).call(this,{type:r.READ_FILE,data:{path:e,encoding:s}},void 0,n));c(this,"deleteFile",(e,{signal:s}={})=>i(this,l).call(this,{type:r.DELETE_FILE,data:{path:e}},void 0,s));c(this,"rename",(e,s,{signal:n}={})=>i(this,l).call(this,{type:r.RENAME,data:{oldPath:e,newPath:s}},void 0,n));c(this,"createDir",(e,{signal:s}={})=>i(this,l).call(this,{type:r.CREATE_DIR,data:{path:e}},void 0,s));c(this,"listDir",(e,{signal:s}={})=>i(this,l).call(this,{type:r.LIST_DIR,data:{path:e}},void 0,s));c(this,"deleteDir",(e,{signal:s}={})=>i(this,l).call(this,{type:r.DELETE_DIR,data:{path:e}},void 0,s))}on(e,s){e==="log"?i(this,O).push(s):e==="progress"&&i(this,L).push(s)}off(e,s){e==="log"?w(this,O,i(this,O).filter(n=>n!==s)):e==="progress"&&w(this,L,i(this,L).filter(n=>n!==s))}}E=new WeakMap,D=new WeakMap,m=new WeakMap,O=new WeakMap,L=new WeakMap,b=new WeakMap,l=new WeakMap;var x;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(x||(x={}));function T(t){var n;const e="/".replace(/\/+$/,"/"),s=((n=self.location)==null?void 0:n.origin)||"";return new URL(e+t.replace(/^\/+/,""),s).toString()}const u=new Z;let B=!1;function p(t,e){postMessage({id:t,log:e})}function ee(t,e){postMessage({id:t,progress:Math.max(0,Math.min(100,Math.round(e*100)))})}async function te(t){B||(p(t,"FFmpeg load start"),await u.load({coreURL:T("ffmpeg/ffmpeg-core.js"),wasmURL:T("ffmpeg/ffmpeg-core.wasm"),workerURL:T("ffmpeg/ffmpeg-worker.js")}),u.on("log",({type:e,message:s})=>p(t,`[ffmpeg ${e}] ${s}`)),u.on("progress",({progress:e})=>ee(t,e)),B=!0,p(t,"FFmpeg load complete"))}function M(t){return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}function se(t){const e=t.lastIndexOf(".");return e>0?t.slice(0,e):t}function ne(t,e,s){const n=[];n.push("#EXTM3U"),n.push("#EXT-X-VERSION:7"),n.push("#EXT-X-INDEPENDENT-SEGMENTS");const a=t==="aac"?'CODECS="mp4a.40.2"':'CODECS="opus"';for(let o=0;o<e.length;o++){const _=e[o],R=Math.max(32,_.audioBitrateKbps)*1e3;n.push(`#EXT-X-STREAM-INF:BANDWIDTH=${R},${a}`),n.push(s[o])}return n.join(`
`)+`
`}function ie(t,e,s){return t==="opus"&&e==="ts"?(s("Switching to fMP4 because Opus in HLS requires fMP4 segments"),"fmp4"):e}function re(t,e,s){const n=[];if(e.channels&&n.push("-ac",String(e.channels)),t==="opus"){const a=new Set([8e3,12e3,16e3,24e3,48e3]);let o=e.sampleRateHz;(!o||!a.has(o))&&(o&&!a.has(o)&&s(`Adjusting sample rate ${o} to 48000 for Opus`),o=48e3),n.push("-ar",String(o))}else e.sampleRateHz&&n.push("-ar",String(e.sampleRateHz));return n}self.onmessage=async t=>{const{id:e,name:s,mime:n,arrayBuffer:a,codec:o,segmentSeconds:_,segmentType:R,renditions:I}=t.data;try{if(!(a instanceof ArrayBuffer))throw new Error("Input is not an ArrayBuffer");if(!Array.isArray(I)||I.length===0)throw new Error("No renditions provided");await te(e),p(e,`Write input ${s} ${a.byteLength} bytes`),await u.writeFile(s,new Uint8Array(a));const h=[],U=[],$=ie(o,R,f=>p(e,f));for(let f=0;f<I.length;f++){const A=I[f],S=`a${f}.m3u8`,z=["-c:a",o==="aac"?"aac":"libopus","-b:a",`${Math.max(32,A.audioBitrateKbps)}k`,...o==="opus"?["-application","audio"]:[]],G=re(o,A,d=>p(e,d)),K=$==="fmp4"?["-hls_segment_type","fmp4","-hls_flags","independent_segments","-hls_fmp4_init_filename",`a${f}_init.mp4`,"-hls_segment_filename",`a${f}_%03d.m4s`]:["-hls_segment_filename",`a${f}_%03d.ts`],P=["-i",s,"-vn",...z,...G,"-f","hls","-hls_time",String(_||6),"-hls_playlist_type","vod","-hls_list_size","0",...K,S];p(e,`Exec a${f} ${JSON.stringify(P)}`),await u.exec(P);const N=await u.readFile(S);if(!N||N.byteLength===0)throw new Error(`Child playlist missing for rendition ${f}`);h.push({name:S,type:"application/vnd.apple.mpegurl",buffer:M(N)}),U.push(S);const C=new TextDecoder().decode(N),X=C.match(/#EXT-X-MAP:URI="([^"]+)"/);if(X){const d=X[1],y=await u.readFile(d);h.push({name:d,type:"video/mp4",buffer:M(y)})}const v=Array.from(C.matchAll(/^[^#].+\.(m4s|ts|aac)$/gm)).map(d=>d[0]);p(e,`Rendition ${f} segments ${v.length}`);for(const d of v){const y=await u.readFile(d);h.push({name:d,type:$==="fmp4"?"video/iso.segment":"video/mp2t",buffer:M(y)})}}const F=ne(o,I,U);h.push({name:"master.m3u8",type:"application/vnd.apple.mpegurl",buffer:new TextEncoder().encode(F).buffer});const H=se(s)+"_hls_audio",j=h.reduce((f,A)=>f+A.buffer.byteLength,0);p(e,`Audio HLS output files ${h.length} bytes ${j}`),postMessage({id:e,folder:H,files:h},h.map(f=>f.buffer))}catch(h){postMessage({id:e,error:(h==null?void 0:h.message)||"Audio HLS ladder failed"})}finally{try{await u.deleteFile(s)}catch{}}};
