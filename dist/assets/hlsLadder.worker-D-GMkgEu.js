var V=Object.defineProperty;var x=e=>{throw TypeError(e)};var q=(e,t,s)=>t in e?V(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var f=(e,t,s)=>q(e,typeof t!="symbol"?t+"":t,s),k=(e,t,s)=>t.has(e)||x("Cannot "+s);var r=(e,t,s)=>(k(e,t,"read from private field"),s?s.call(e):t.get(e)),u=(e,t,s)=>t.has(e)?x("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),_=(e,t,s,i)=>(k(e,t,"write to private field"),i?i.call(e,s):t.set(e,s),s);var n;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(n||(n={}));const Q=(()=>{let e=0;return()=>e++})(),Z=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),tt=new Error("called FFmpeg.terminate()");var l,g,p,D,L,S,c;class et{constructor(){u(this,l,null);u(this,g,{});u(this,p,{});u(this,D,[]);u(this,L,[]);f(this,"loaded",!1);u(this,S,()=>{r(this,l)&&(r(this,l).onmessage=({data:{id:t,type:s,data:i}})=>{switch(s){case n.LOAD:this.loaded=!0,r(this,g)[t](i);break;case n.MOUNT:case n.UNMOUNT:case n.EXEC:case n.FFPROBE:case n.WRITE_FILE:case n.READ_FILE:case n.DELETE_FILE:case n.RENAME:case n.CREATE_DIR:case n.LIST_DIR:case n.DELETE_DIR:r(this,g)[t](i);break;case n.LOG:r(this,D).forEach(o=>o(i));break;case n.PROGRESS:r(this,L).forEach(o=>o(i));break;case n.ERROR:r(this,p)[t](i);break}delete r(this,g)[t],delete r(this,p)[t]})});u(this,c,({type:t,data:s},i=[],o)=>r(this,l)?new Promise((w,d)=>{const h=Q();r(this,l)&&r(this,l).postMessage({id:h,type:t,data:s},i),r(this,g)[h]=w,r(this,p)[h]=d,o==null||o.addEventListener("abort",()=>{d(new DOMException(`Message # ${h} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(Z));f(this,"load",({classWorkerURL:t,...s}={},{signal:i}={})=>(r(this,l)||(_(this,l,t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),r(this,S).call(this)),r(this,c).call(this,{type:n.LOAD,data:s},void 0,i)));f(this,"exec",(t,s=-1,{signal:i}={})=>r(this,c).call(this,{type:n.EXEC,data:{args:t,timeout:s}},void 0,i));f(this,"ffprobe",(t,s=-1,{signal:i}={})=>r(this,c).call(this,{type:n.FFPROBE,data:{args:t,timeout:s}},void 0,i));f(this,"terminate",()=>{const t=Object.keys(r(this,p));for(const s of t)r(this,p)[s](tt),delete r(this,p)[s],delete r(this,g)[s];r(this,l)&&(r(this,l).terminate(),_(this,l,null),this.loaded=!1)});f(this,"writeFile",(t,s,{signal:i}={})=>{const o=[];return s instanceof Uint8Array&&o.push(s.buffer),r(this,c).call(this,{type:n.WRITE_FILE,data:{path:t,data:s}},o,i)});f(this,"mount",(t,s,i)=>{const o=[];return r(this,c).call(this,{type:n.MOUNT,data:{fsType:t,options:s,mountPoint:i}},o)});f(this,"unmount",t=>{const s=[];return r(this,c).call(this,{type:n.UNMOUNT,data:{mountPoint:t}},s)});f(this,"readFile",(t,s="binary",{signal:i}={})=>r(this,c).call(this,{type:n.READ_FILE,data:{path:t,encoding:s}},void 0,i));f(this,"deleteFile",(t,{signal:s}={})=>r(this,c).call(this,{type:n.DELETE_FILE,data:{path:t}},void 0,s));f(this,"rename",(t,s,{signal:i}={})=>r(this,c).call(this,{type:n.RENAME,data:{oldPath:t,newPath:s}},void 0,i));f(this,"createDir",(t,{signal:s}={})=>r(this,c).call(this,{type:n.CREATE_DIR,data:{path:t}},void 0,s));f(this,"listDir",(t,{signal:s}={})=>r(this,c).call(this,{type:n.LIST_DIR,data:{path:t}},void 0,s));f(this,"deleteDir",(t,{signal:s}={})=>r(this,c).call(this,{type:n.DELETE_DIR,data:{path:t}},void 0,s))}on(t,s){t==="log"?r(this,D).push(s):t==="progress"&&r(this,L).push(s)}off(t,s){t==="log"?_(this,D,r(this,D).filter(i=>i!==s)):t==="progress"&&_(this,L,r(this,L).filter(i=>i!==s))}}l=new WeakMap,g=new WeakMap,p=new WeakMap,D=new WeakMap,L=new WeakMap,S=new WeakMap,c=new WeakMap;var B;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(B||(B={}));function $(e){var i;const t="/".replace(/\/+$/,"/"),s=((i=self.location)==null?void 0:i.origin)||"";return new URL(t+e.replace(/^\/+/,""),s).toString()}const m=new et;let P=!1;function R(e,t){postMessage({id:e,log:t})}function st(e,t){postMessage({id:e,progress:Math.max(0,Math.min(100,Math.round(t*100)))})}async function rt(e){P||(R(e,"FFmpeg load start"),await m.load({coreURL:$("ffmpeg/ffmpeg-core.js"),wasmURL:$("ffmpeg/ffmpeg-core.wasm"),workerURL:$("ffmpeg/ffmpeg-worker.js")}),m.on("log",({type:t,message:s})=>R(e,`[ffmpeg ${t}] ${s}`)),m.on("progress",({progress:t})=>st(e,t)),P=!0,R(e,"FFmpeg load complete"))}function W(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function it(e){const t=e.lastIndexOf(".");return t>0?e.slice(0,t):e}function nt(e,t){const s=[];s.push("#EXTM3U"),s.push("#EXT-X-VERSION:3"),s.push("#EXT-X-INDEPENDENT-SEGMENTS");for(let i=0;i<e.length;i++){const o=e[i],w=Math.max(64,Math.round((o.videoBitrateKbps+o.audioBitrateKbps)*1e3)),d=o.width&&o.height?`,RESOLUTION=${o.width}x${o.height}`:"",h=o.name||(o.height?`${o.height}p`:`v${i}`);s.push(`#EXT-X-STREAM-INF:BANDWIDTH=${w}${d},NAME="${h}"`),s.push(t[i])}return s.join(`
`)+`
`}self.onmessage=async e=>{const{id:t,name:s,mime:i,arrayBuffer:o,segmentSeconds:w,renditions:d}=e.data;try{if(!(o instanceof ArrayBuffer))throw new Error("Input is not an ArrayBuffer");if(!Array.isArray(d)||d.length===0)throw new Error("No renditions provided");await rt(t),R(t,`Write input ${s} size ${o.byteLength}`),await m.writeFile(s,new Uint8Array(o));const h=[],y=[];for(let E=0;E<d.length;E++){const a=d[E];R(t,`Rendition ${E} start ${JSON.stringify(a)}`);const I=[];if(a.width||a.height){const O=a.width??-2,A=a.height??-2,U=`scale=${O}:${A}:force_original_aspect_ratio=decrease:eval=frame`;a.padToExact&&a.width&&a.height?I.push(`${U},pad=${a.width}:${a.height}:(ow-iw)/2:(oh-ih)/2:color=black`):I.push(U),I.push("setsar=1:1")}const T=Math.max(12,Math.round((a.gopSeconds??2)*24)),v=`${Math.max(64,a.videoBitrateKbps)}k`,K=`${Math.max(32,a.audioBitrateKbps)}k`,j=a.preset??"veryfast",G=a.profile??"high",z=a.crf??23,b=`v${E}.m3u8`,H=`v${E}_%03d.ts`,Y=["-i",s,"-c:v","libx264","-preset",j,"-profile:v",G,"-crf",String(z),"-b:v",v,"-maxrate",v,"-bufsize",String(Math.max(64,a.videoBitrateKbps*2))+"k","-g",String(T),"-keyint_min",String(T),"-sc_threshold","0",...I.length?["-vf",I.join(",")]:[],"-c:a","aac","-b:a",K,"-ac",String(a.audioChannels??2),"-f","hls","-hls_time",String(w||6),"-hls_playlist_type","vod","-hls_list_size","0","-hls_segment_filename",H,b];R(t,`Exec rendition ${E}`),await m.exec(Y);const N=await m.readFile(b);if(!N||N.byteLength===0)throw new Error(`Child playlist missing for rendition ${E}`);h.push({name:b,type:"application/vnd.apple.mpegurl",buffer:W(N)}),y.push(b);const J=new TextDecoder().decode(N),M=Array.from(J.matchAll(/^[^#].*\.ts$/gm)).map(O=>O[0]);R(t,`Rendition ${E} segments ${M.length}`);for(const O of M){const A=await m.readFile(O);h.push({name:O,type:"video/mp2t",buffer:W(A)})}}const X=nt(d,y);h.push({name:"master.m3u8",type:"application/vnd.apple.mpegurl",buffer:new TextEncoder().encode(X).buffer});const C=it(s)+"_hls_multi",F=h.reduce((E,a)=>E+a.buffer.byteLength,0);R(t,`Ladder output files ${h.length} total bytes ${F}`),postMessage({id:t,folder:C,files:h},h.map(E=>E.buffer))}catch(h){postMessage({id:t,error:(h==null?void 0:h.message)||"HLS ladder failed"})}finally{try{await m.deleteFile(s)}catch{}}};
