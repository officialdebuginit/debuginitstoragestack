var C=Object.defineProperty;var S=e=>{throw TypeError(e)};var W=(e,t,r)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var c=(e,t,r)=>W(e,typeof t!="symbol"?t+"":t,r),k=(e,t,r)=>t.has(e)||S("Cannot "+r);var i=(e,t,r)=>(k(e,t,"read from private field"),r?r.call(e):t.get(e)),b=(e,t,r)=>t.has(e)?S("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),A=(e,t,r,a)=>(k(e,t,"write to private field"),a?a.call(e,r):t.set(e,r),r);var s;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(s||(s={}));const j=(()=>{let e=0;return()=>e++})(),G=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),X=new Error("called FFmpeg.terminate()");var l,R,E,w,g,_,f;class H{constructor(){b(this,l,null);b(this,R,{});b(this,E,{});b(this,w,[]);b(this,g,[]);c(this,"loaded",!1);b(this,_,()=>{i(this,l)&&(i(this,l).onmessage=({data:{id:t,type:r,data:a}})=>{switch(r){case s.LOAD:this.loaded=!0,i(this,R)[t](a);break;case s.MOUNT:case s.UNMOUNT:case s.EXEC:case s.FFPROBE:case s.WRITE_FILE:case s.READ_FILE:case s.DELETE_FILE:case s.RENAME:case s.CREATE_DIR:case s.LIST_DIR:case s.DELETE_DIR:i(this,R)[t](a);break;case s.LOG:i(this,w).forEach(n=>n(a));break;case s.PROGRESS:i(this,g).forEach(n=>n(a));break;case s.ERROR:i(this,E)[t](a);break}delete i(this,R)[t],delete i(this,E)[t]})});b(this,f,({type:t,data:r},a=[],n)=>i(this,l)?new Promise((m,D)=>{const o=j();i(this,l)&&i(this,l).postMessage({id:o,type:t,data:r},a),i(this,R)[o]=m,i(this,E)[o]=D,n==null||n.addEventListener("abort",()=>{D(new DOMException(`Message # ${o} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(G));c(this,"load",({classWorkerURL:t,...r}={},{signal:a}={})=>(i(this,l)||(A(this,l,t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),i(this,_).call(this)),i(this,f).call(this,{type:s.LOAD,data:r},void 0,a)));c(this,"exec",(t,r=-1,{signal:a}={})=>i(this,f).call(this,{type:s.EXEC,data:{args:t,timeout:r}},void 0,a));c(this,"ffprobe",(t,r=-1,{signal:a}={})=>i(this,f).call(this,{type:s.FFPROBE,data:{args:t,timeout:r}},void 0,a));c(this,"terminate",()=>{const t=Object.keys(i(this,E));for(const r of t)i(this,E)[r](X),delete i(this,E)[r],delete i(this,R)[r];i(this,l)&&(i(this,l).terminate(),A(this,l,null),this.loaded=!1)});c(this,"writeFile",(t,r,{signal:a}={})=>{const n=[];return r instanceof Uint8Array&&n.push(r.buffer),i(this,f).call(this,{type:s.WRITE_FILE,data:{path:t,data:r}},n,a)});c(this,"mount",(t,r,a)=>{const n=[];return i(this,f).call(this,{type:s.MOUNT,data:{fsType:t,options:r,mountPoint:a}},n)});c(this,"unmount",t=>{const r=[];return i(this,f).call(this,{type:s.UNMOUNT,data:{mountPoint:t}},r)});c(this,"readFile",(t,r="binary",{signal:a}={})=>i(this,f).call(this,{type:s.READ_FILE,data:{path:t,encoding:r}},void 0,a));c(this,"deleteFile",(t,{signal:r}={})=>i(this,f).call(this,{type:s.DELETE_FILE,data:{path:t}},void 0,r));c(this,"rename",(t,r,{signal:a}={})=>i(this,f).call(this,{type:s.RENAME,data:{oldPath:t,newPath:r}},void 0,a));c(this,"createDir",(t,{signal:r}={})=>i(this,f).call(this,{type:s.CREATE_DIR,data:{path:t}},void 0,r));c(this,"listDir",(t,{signal:r}={})=>i(this,f).call(this,{type:s.LIST_DIR,data:{path:t}},void 0,r));c(this,"deleteDir",(t,{signal:r}={})=>i(this,f).call(this,{type:s.DELETE_DIR,data:{path:t}},void 0,r))}on(t,r){t==="log"?i(this,w).push(r):t==="progress"&&i(this,g).push(r)}off(t,r){t==="log"?A(this,w,i(this,w).filter(a=>a!==r)):t==="progress"&&A(this,g,i(this,g).filter(a=>a!==r))}}l=new WeakMap,R=new WeakMap,E=new WeakMap,w=new WeakMap,g=new WeakMap,_=new WeakMap,f=new WeakMap;var v;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(v||(v={}));function x(e){var a;const t="/".replace(/\/+$/,"/"),r=((a=self.location)==null?void 0:a.origin)||"";return new URL(t+e.replace(/^\/+/,""),r).toString()}const u=new H;let B=!1;function p(e,t){postMessage({id:e,log:t})}function Y(e,t){postMessage({id:e,progress:Math.max(0,Math.min(100,Math.round(t*100)))})}async function z(e){if(!B){p(e,"FFmpeg load start"),await u.load({coreURL:x("ffmpeg/ffmpeg-core.js"),wasmURL:x("ffmpeg/ffmpeg-core.wasm"),workerURL:x("ffmpeg/ffmpeg-worker.js")}),u.on("log",({type:t,message:r})=>p(e,`[ffmpeg ${t}] ${r}`)),u.on("progress",({progress:t})=>Y(e,t)),B=!0,p(e,"FFmpeg load complete");try{p(e,"FFmpeg version probe start"),await u.exec(["-version"])}catch{}}}function J(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function V(e){const t=e.lastIndexOf(".");return t>0?e.slice(0,t):e}function F(e){return e==="mp4"?"mp4":e==="webm"?"webm":"mkv"}function q(e){return e==="mp4"?"video/mp4":e==="webm"?"video/webm":"video/x-matroska"}function Q(e,t,r,a){const n=V(e),m=F(t.container),D=t.namePattern&&t.namePattern.trim().length?t.namePattern:"{base}_{w}x{h}_{vcodec}.{ext}",o=r||t.width||0,y=a||t.height||0;return D.replaceAll("{base}",n).replaceAll("{w}",String(o)).replaceAll("{h}",String(y)).replaceAll("{vcodec}",t.vcodec).replaceAll("{acodec}",t.acodec).replaceAll("{ext}",m)}function Z(e){if(e.vcodec==="h264"){const r=["-c:v","libx264","-pix_fmt","yuv420p","-preset",e.preset??"veryfast","-profile:v",e.profile??"high"];return e.mode==="vbr"&&e.videoBitrateKbps?r.push("-b:v",`${e.videoBitrateKbps}k`,"-maxrate",`${e.videoBitrateKbps}k`,"-bufsize",`${Math.max(64,(e.videoBitrateKbps||1)*2)}k`):r.push("-crf",String(e.crf??23)),r}if(e.vcodec==="h265"){const r=["-c:v","libx265","-pix_fmt","yuv420p","-preset",e.preset??"veryfast"];return e.mode==="vbr"&&e.videoBitrateKbps?r.push("-b:v",`${e.videoBitrateKbps}k`):r.push("-crf",String(e.crf??28)),r}if(e.vcodec==="vp9"){const r=["-c:v","libvpx-vp9","-pix_fmt","yuv420p","-crf",String(e.crf??32)];return e.mode==="vbr"&&e.videoBitrateKbps&&r.push("-b:v",`${e.videoBitrateKbps}k`),r}const t=["-c:v","libaom-av1","-pix_fmt","yuv420p","-crf",String(e.crf??35)];return e.mode==="vbr"&&e.videoBitrateKbps&&t.push("-b:v",`${e.videoBitrateKbps}k`),t}function ee(e){return e.acodec==="aac"?["-c:a","aac","-b:a",`${e.audioBitrateKbps??128}k`]:["-c:a","libopus","-b:a",`${e.audioBitrateKbps??128}k`]}function te(e){const t=[];if(e.width||e.height){const r=e.width??-2,a=e.height??-2,n=`scale=${r}:${a}:force_original_aspect_ratio=decrease:eval=frame`;e.padToExact&&e.width&&e.height?t.push(`${n},pad=${e.width}:${e.height}:(ow-iw)/2:(oh-ih)/2:color=black`):t.push(n),t.push("setsar=1:1")}return e.fps&&e.fps>0&&t.push(`fps=${Math.round(e.fps)}`),t.length?t.join(","):null}async function U(e,t){try{const r=await u.listDir("."),a=Array.isArray(r)?r.map(n=>n.name).join(", "):JSON.stringify(r);p(e,`fs ${t}: ${a}`)}catch{}}self.onmessage=async e=>{const{id:t,name:r,mime:a,arrayBuffer:n,variants:m}=e.data,D=performance.now();try{if(!(n instanceof ArrayBuffer))throw new Error("Input is not an ArrayBuffer");if(!Array.isArray(m)||m.length===0)throw new Error("No variants provided");await z(t),p(t,`write input ${r} bytes ${n.byteLength}`),await u.writeFile(r,new Uint8Array(n)),await U(t,"after write input");try{p(t,"input probe start"),await u.exec(["-hide_banner","-i",r,"-f","null","-"]),p(t,"input probe complete")}catch{p(t,"input probe produced expected error because of null muxer")}const o=[];for(let d=0;d<m.length;d++){const h=m[d],N=te(h),M=F(h.container),O=`v${d}.${M}`,L=["-i",r,...Z(h),...ee(h),...N?["-vf",N]:[]];h.container==="mp4"?L.push("-movflags","+faststart","-f","mp4",O):h.container==="webm"?L.push("-f","webm",O):L.push("-f","matroska",O),p(t,`variant ${d} args ${JSON.stringify(L)}`);const K=performance.now();await u.exec(L);const P=performance.now();p(t,`variant ${d} exec ms ${(P-K).toFixed(0)}`),await U(t,`after variant ${d}`);let I;try{I=await u.readFile(O)}catch($){p(t,`readFile failed ${O} ${($==null?void 0:$.message)||""}`)}if(!I||I.byteLength===0)throw new Error(`Variant ${d} empty output. Check console log for encoder errors such as Unknown encoder`);const T=Q(r,h,h.width,h.height);o.push({name:T,type:q(h.container),buffer:J(I)});try{await u.deleteFile(O)}catch{}}const y=o.reduce((d,h)=>d+h.buffer.byteLength,0);p(t,`variants done count ${o.length} bytes ${y} total in ms ${(performance.now()-D).toFixed(0)}`),postMessage({id:t,files:o},o.map(d=>d.buffer))}catch(o){postMessage({id:t,error:(o==null?void 0:o.message)||"Video variants failed"})}finally{try{await u.deleteFile(r)}catch{}}};
